//
// Copyright 2020 FoxyUtils ehf. All rights reserved.
//
// This is a commercial product and requires a license to operate.
// A trial license can be obtained at https://unidoc.io
//
// DO NOT EDIT: generated by unitwist Go source code obfuscator.
//
// Use of this source code is governed by the UniDoc End User License Agreement
// terms that can be accessed at https://unidoc.io/eula/

package testutils ;import (_e "crypto/md5";_gb "encoding/hex";_eed "errors";_df "fmt";_da "github.com/unidoc/unipdf/v4/common";_ea "github.com/unidoc/unipdf/v4/core";_fe "image";_eeg "image/png";_d "io";_cc "os";_ee "os/exec";_a "path/filepath";_f "strings";
_c "testing";);func RunRenderTest (t *_c .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ){_cg :=_f .TrimSuffix (_a .Base (pdfPath ),_a .Ext (pdfPath ));t .Run ("\u0072\u0065\u006e\u0064\u0065\u0072",func (_dd *_c .T ){_bc :=_a .Join (outputDir ,_cg );
_gdb :=_bc +"\u002d%\u0064\u002e\u0070\u006e\u0067";if _ba :=RenderPDFToPNGs (pdfPath ,0,_gdb );_ba !=nil {_dd .Skip (_ba );};for _ec :=1;true ;_ec ++{_bdf :=_df .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_bc ,_ec );_bdb :=_a .Join (baselineRenderPath ,_df .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_cg ,_ec ));
if _ ,_cgc :=_cc .Stat (_bdf );_cgc !=nil {break ;};_dd .Logf ("\u0025\u0073",_bdb );if saveBaseline {_dd .Logf ("\u0043\u006fp\u0079\u0069\u006eg\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_bdf ,_bdb );_cga :=CopyFile (_bdf ,_bdb );if _cga !=nil {_dd .Fatalf ("\u0045\u0052\u0052OR\u0020\u0063\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u0074\u006f\u0020\u0025\u0073\u003a\u0020\u0025\u0076",_bdb ,_cga );
};continue ;};_dd .Run (_df .Sprintf ("\u0070\u0061\u0067\u0065\u0025\u0064",_ec ),func (_gf *_c .T ){_gf .Logf ("\u0043o\u006dp\u0061\u0072\u0069\u006e\u0067 \u0025\u0073 \u0076\u0073\u0020\u0025\u0073",_bdf ,_bdb );_gg ,_fca :=ComparePNGFiles (_bdf ,_bdb );
if _cc .IsNotExist (_fca ){_gf .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_gg {_gf .Fatal ("\u0077\u0072\u006f\u006eg \u0070\u0061\u0067\u0065\u0020\u0072\u0065\u006e\u0064\u0065\u0072\u0065\u0064");
};});};});};func CopyFile (src ,dst string )error {_ce ,_fg :=_cc .Open (src );if _fg !=nil {return _fg ;};defer _ce .Close ();_ac ,_fg :=_cc .Create (dst );if _fg !=nil {return _fg ;};defer _ac .Close ();_ ,_fg =_d .Copy (_ac ,_ce );return _fg ;};func ParseIndirectObjects (rawpdf string )(map[int64 ]_ea .PdfObject ,error ){_dbb :=_ea .NewParserFromString (rawpdf );
_aca :=map[int64 ]_ea .PdfObject {};for {_cf ,_afa :=_dbb .ParseIndirectObject ();if _afa !=nil {if _afa ==_d .EOF {break ;};return nil ,_afa ;};switch _cce :=_cf .(type ){case *_ea .PdfIndirectObject :_aca [_cce .ObjectNumber ]=_cf ;case *_ea .PdfObjectStream :_aca [_cce .ObjectNumber ]=_cf ;
};};for _ ,_dff :=range _aca {_fa (_dff ,_aca );};return _aca ,nil ;};func CompareDictionariesDeep (d1 ,d2 *_ea .PdfObjectDictionary )bool {if len (d1 .Keys ())!=len (d2 .Keys ()){_da .Log .Debug ("\u0044\u0069\u0063\u0074\u0020\u0065\u006e\u0074\u0072\u0069\u0065\u0073\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",len (d1 .Keys ()),len (d2 .Keys ()));
_da .Log .Debug ("\u0057\u0061s\u0020\u0027\u0025s\u0027\u0020\u0076\u0073\u0020\u0027\u0025\u0073\u0027",d1 .Write (),d2 .Write ());return false ;};for _ ,_gda :=range d1 .Keys (){if _gda =="\u0050\u0061\u0072\u0065\u006e\u0074"{continue ;};_ga :=_ea .TraceToDirectObject (d1 .Get (_gda ));
_gae :=_ea .TraceToDirectObject (d2 .Get (_gda ));if _ga ==nil {_da .Log .Debug ("\u00761\u0020\u0069\u0073\u0020\u006e\u0069l");return false ;};if _gae ==nil {_da .Log .Debug ("\u00762\u0020\u0069\u0073\u0020\u006e\u0069l");return false ;};switch _ada :=_ga .(type ){case *_ea .PdfObjectDictionary :_fad ,_bca :=_gae .(*_ea .PdfObjectDictionary );
if !_bca {_da .Log .Debug ("\u0054\u0079\u0070\u0065 m\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0020\u0025\u0054\u0020\u0076\u0073\u0020%\u0054",_ga ,_gae );return false ;};if !CompareDictionariesDeep (_ada ,_fad ){return false ;};continue ;case *_ea .PdfObjectArray :_aa ,_ddd :=_gae .(*_ea .PdfObjectArray );
if !_ddd {_da .Log .Debug ("\u00762\u0020n\u006f\u0074\u0020\u0061\u006e\u0020\u0061\u0072\u0072\u0061\u0079");return false ;};if _ada .Len ()!=_aa .Len (){_da .Log .Debug ("\u0061\u0072\u0072\u0061\u0079\u0020\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",_ada .Len (),_aa .Len ());
return false ;};for _dae :=0;_dae < _ada .Len ();_dae ++{_efc :=_ea .TraceToDirectObject (_ada .Get (_dae ));_fd :=_ea .TraceToDirectObject (_aa .Get (_dae ));if _cbd ,_dfb :=_efc .(*_ea .PdfObjectDictionary );_dfb {_fab ,_cd :=_fd .(*_ea .PdfObjectDictionary );
if !_cd {return false ;};if !CompareDictionariesDeep (_cbd ,_fab ){return false ;};}else {_fda :=_efc .Write ();_daf :=_fd .Write ();if string (_fda )!=string (_daf ){_da .Log .Debug ("M\u0069\u0073\u006d\u0061tc\u0068 \u0027\u0025\u0073\u0027\u0020!\u003d\u0020\u0027\u0025\u0073\u0027",_fda ,_daf );
return false ;};};};continue ;};if _ga .String ()!=_gae .String (){_da .Log .Debug ("\u006b\u0065y\u003d\u0025\u0073\u0020\u004d\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0021\u0020\u0027\u0025\u0073\u0027\u0020\u0021\u003d\u0020'%\u0073\u0027",_gda ,_ga .String (),_gae .String ());
_da .Log .Debug ("\u0046o\u0072 \u0027\u0025\u0054\u0027\u0020\u002d\u0020\u0027\u0025\u0054\u0027",_ga ,_gae );_da .Log .Debug ("\u0046\u006f\u0072\u0020\u0027\u0025\u002b\u0076\u0027\u0020\u002d\u0020'\u0025\u002b\u0076\u0027",_ga ,_gae );return false ;
};};return true ;};func ReadPNG (file string )(_fe .Image ,error ){_ff ,_ad :=_cc .Open (file );if _ad !=nil {return nil ,_ad ;};defer _ff .Close ();return _eeg .Decode (_ff );};func _fa (_be _ea .PdfObject ,_dac map[int64 ]_ea .PdfObject )error {switch _ced :=_be .(type ){case *_ea .PdfIndirectObject :_eea :=_ced ;
_fa (_eea .PdfObject ,_dac );case *_ea .PdfObjectDictionary :_gfb :=_ced ;for _ ,_bac :=range _gfb .Keys (){_cbg :=_gfb .Get (_bac );if _afb ,_ecb :=_cbg .(*_ea .PdfObjectReference );_ecb {_cgb ,_eac :=_dac [_afb .ObjectNumber ];if !_eac {return _eed .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");
};_gfb .Set (_bac ,_cgb );}else {_fa (_cbg ,_dac );};};case *_ea .PdfObjectArray :_ebd :=_ced ;for _fcd ,_adg :=range _ebd .Elements (){if _bg ,_bfg :=_adg .(*_ea .PdfObjectReference );_bfg {_fga ,_ccd :=_dac [_bg .ObjectNumber ];if !_ccd {return _eed .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");
};_ebd .Set (_fcd ,_fga );}else {_fa (_adg ,_dac );};};};return nil ;};func HashFile (file string )(string ,error ){_gd ,_gbc :=_cc .Open (file );if _gbc !=nil {return "",_gbc ;};defer _gd .Close ();_cea :=_e .New ();if _ ,_gbc =_d .Copy (_cea ,_gd );_gbc !=nil {return "",_gbc ;
};return _gb .EncodeToString (_cea .Sum (nil )),nil ;};func CompareImages (img1 ,img2 _fe .Image )(bool ,error ){_eb :=img1 .Bounds ();_fc :=0;for _b :=0;_b < _eb .Size ().X ;_b ++{for _fcc :=0;_fcc < _eb .Size ().Y ;_fcc ++{_bd ,_bb ,_eef ,_ :=img1 .At (_b ,_fcc ).RGBA ();
_db ,_ffe ,_af ,_ :=img2 .At (_b ,_fcc ).RGBA ();if _bd !=_db ||_bb !=_ffe ||_eef !=_af {_fc ++;};};};_bf :=float64 (_fc )/float64 (_eb .Dx ()*_eb .Dy ());if _bf > 0.0001{_df .Printf ("\u0064\u0069\u0066f \u0066\u0072\u0061\u0063\u0074\u0069\u006f\u006e\u003a\u0020\u0025\u0076\u0020\u0028\u0025\u0064\u0029\u000a",_bf ,_fc );
return false ,nil ;};return true ,nil ;};func ComparePNGFiles (file1 ,file2 string )(bool ,error ){_dg ,_bbd :=HashFile (file1 );if _bbd !=nil {return false ,_bbd ;};_eg ,_bbd :=HashFile (file2 );if _bbd !=nil {return false ,_bbd ;};if _dg ==_eg {return true ,nil ;
};_afd ,_bbd :=ReadPNG (file1 );if _bbd !=nil {return false ,_bbd ;};_gc ,_bbd :=ReadPNG (file2 );if _bbd !=nil {return false ,_bbd ;};if _afd .Bounds ()!=_gc .Bounds (){return false ,nil ;};return CompareImages (_afd ,_gc );};func RenderPDFToPNGs (pdfPath string ,dpi int ,outpathTpl string )error {if dpi <=0{dpi =100;
};if _ ,_egb :=_ee .LookPath ("\u0067\u0073");_egb !=nil {return ErrRenderNotSupported ;};return _ee .Command ("\u0067\u0073","\u002d\u0073\u0044\u0045\u0056\u0049\u0043\u0045\u003d\u0070\u006e\u0067a\u006c\u0070\u0068\u0061","\u002d\u006f",outpathTpl ,_df .Sprintf ("\u002d\u0072\u0025\u0064",dpi ),pdfPath ).Run ();
};var (ErrRenderNotSupported =_eed .New ("\u0072\u0065\u006e\u0064\u0065r\u0069\u006e\u0067\u0020\u0050\u0044\u0046\u0020\u0066\u0069\u006c\u0065\u0073 \u0069\u0073\u0020\u006e\u006f\u0074\u0020\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065\u0064\u0020\u006f\u006e\u0020\u0074\u0068\u0069\u0073\u0020\u0073\u0079\u0073\u0074\u0065m");
);